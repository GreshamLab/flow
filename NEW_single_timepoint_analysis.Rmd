---
title: "Gresham Lab Floww Cytometry Single Timepoint Analysis"
author: 'G. Avecilla, N. Brandt, S. Lauer, F. Abdul-Rahman, D. Gresham'
date: '`r Sys.Date()`'
output: html_notebook
---

This notebook contains the code necessary to analysis flow cytometry data in the Gresham Lab. 

To analyze flow cytometry data, you MUST use the latest version of this code, available on the [Gresham Lab github](https://github.com/GreshamLab/flow).

**Experimental overview**

Write a detailed description of your experiment here including the goal of the analysis and your interpretation of the results.   
If you still see this text it means that you have not described the experiment and whatever follows is meaningless.

*This code is designed for use with the Accuri flow cytometer, which is equiped with the following lasers and filters*

* Blue laser (488 nm)
* FL1 filter = 514/20nm   GFP
* FL3 filter = 575/25nm   YFP

* Yellow/green laser (552 nm)
* FL2 filter = 610/20nm   mCherry, dtomato
* FL4 filter = 586/15nm   DsRed
  
**Requirements**

In order to run this code you need:

* to predefine your gates using the gating.R script
* the gates.Rdata workspace, which contains the gates to be used in this script
* a tab delimited sample sheet in with the first XXXX columns set up as in the example below
* user defined variables, see below and chunk 1

**Output**  
This script generates quality control plots in the notebook and a file(s) with a summary of results.
The user can generate the output file(s) in three different styles: 

1. As a dataframe converted from fcs with all or some of the data.
2. As a dataframe with summary statistics (e.g. median FL1 per sample)
3. As a new .fcs file with additional information (e.g. phenotype or sample information) appended

**Libraries**

```{r Libraries, eval=TRUE}
# This is a function that just makes sure you have a package, or installs it for you without prompting

requireInstall <- function(packageName,isBioconductor=F) {
  if ( !try(require(packageName,character.only=T)) ) {
    print(paste0("You don't have ",packageName," accessible, ",
      "I'm gonna install it"))
    if (isBioconductor) {
      source("http://bioconductor.org/biocLite.R")                        
      biocLite(packageName)                                                 
    } else {
      install.packages("packageName", repos = "http://cran.us.r-project.org")
    }
  }
  return(1)
}

#Load libraries
requireInstall("openCyto",isBioconductor=T)
requireInstall("tidyverse")
```

  
**Variables**
Variables for the user to set can be found in chunk one. These include both required variables (e.g., working directory), and optional variables (e.g., style of ouput). There are some defaults for these variables.


```{r User Defined Variables}
#working directory
dir = '.'
#file location
path.data = paste(getwd(),"/",sep="")
#fcs run sample name
name = "Test"
#fcs data to extract

#style of output


```


**Read in Data**
*.fcs files must be in a folder with a unique name and have an accompanying .csv samplesheet
The samplesheet name format must be samplesheet_"unique name".csv
It must contain the following columns, in addition you may add additioanl columns depending on your needs


Need to define names
* column1 = Well
* column2 = Strain
* column3 = Staining
* column4 = Media
* column5 = Userdefined

```{r}


files<-list.files(paste(path.data,name,"/", sep=""),full.names=TRUE)
flowData <- read.ncdfFlowSet(files=files, pattern=".fcs", alter.names = TRUE)


sample.sheet <- read.csv(paste(path.data,"samplesheet_",name,".csv", sep=""))

#Adds a sample sheet data to the pData of the flowset

sampleNames(flowData) <- paste(gsub(" ","_",sample.sheet$Strain),"_",sub(" ","_",sample.sheet$Well), sep="")

#Need to determine samplesheet inputs
pData(flowData)$Well <- gsub(" ","_",sample.sheet$Well)
pData(flowData)$Strain <- gsub(" ","_",sample.sheet$Strain)
pData(flowData)$Genotype <- gsub(" ","_",sample.sheet$Genotype)
pData(flowData)$Ploidy <- gsub(" ","_",sample.sheet$Ploidy)
pData(flowData)$Media <- gsub(" ","_",sample.sheet$Media)
pData(flowData)$Experiment <- gsub(" ","_",sample.sheet$Experiment)
```

```{r flowSet summaries}
#Check how many cells were counted in each fcs file
total <- fsApply(flowData, each_col, length)[1:length(flowData)] #total counts per sample
print(total)
#Print the medians of data values for each measurement
fsApply(flowData, each_col, median)[1:length(flowData)]

#combine all flowSets into a single flowset
samples.num <- length(flowData)
print(samples.num)
```

#Gating
```{r Application of Gates}
##Subset the data by applying sequential gates##

#Load Gates
load(file = "gates.RData")

#apply doublet gate to ALL SAMPLES
flowData.singlets <- Subset(flowData, pg.singlets) 
fsApply(flowData.singlets, each_col, length)[1:samples.num]
singlets <- fsApply(flowData.singlets, each_col, length)[1:samples.num]
barplot(singlets/total, ylim=c(0,1), ylab = "Proportion singlet cells", las=2, cex.names = 0.5, names.arg=sampleNames(flowData))

#apply debris gates
filteredData <- Subset(flowData.singlets, pg.nondebris) 
fsApply(filteredData, each_col, length)[1:samples.num]
non.debris <- fsApply(filteredData, each_col, length)[1:samples.num]
barplot(non.debris/total, ylim=c(0,1), ylab = "Proportion nondebris cells", las=2, cex.names = 0.5, names.arg=str_sub(sampleNames(filteredData)))

#this gate defines nongfp cells
gfp.neg <- Subset(filteredData, gln.zero) 
fsApply(gfp.neg, each_col, length)[1:samples.num]
non.gfp <- fsApply(gfp.neg, each_col, length)[1:samples.num]
barplot(non.gfp/non.debris, ylim=c(0,1), ylab = "Proportion cells with no GFP", las=2, cex.names = 0.5, names.arg=str_sub(sampleNames(filteredData)))

#this gate defines one copy gfp cells
gfp.one <- Subset(filteredData, gln.one) 
fsApply(gfp.one, each_col, length)[1:samples.num]
gfp.one.cells <- fsApply(gfp.one, each_col, length)[1:samples.num]
barplot(gfp.one.cells/non.debris, ylim=c(0,1), ylab = "Proportion cells with 1 copy GFP", las=2, cex.names = 0.5, names.arg=str_sub(sampleNames(filteredData)))

#this gate defines two copy gfp cells
gfp.two <- Subset(filteredData, gln.two) 
fsApply(gfp.two, each_col, length)[1:samples.num]
gfp.two.cells <- fsApply(gfp.two, each_col, length)[1:samples.num]
  barplot(gfp.two.cells/non.debris, ylim=c(0,1), ylab = "Proportion cells with 2 copy GFP", las=2, cex.names = 0.5, names.arg=str_sub(sampleNames(filteredData)))

#this gate defines thre copy plus gfp cells
gfp.thr <- Subset(filteredData, gln.three) 
fsApply(gfp.thr, each_col, length)[1:samples.num]
gfp.thr.cells <- fsApply(gfp.thr, each_col, length)[1:samples.num]
barplot(gfp.thr.cells/non.debris, ylim=c(0,1), ylab = "Proportion cells with 3 copy+ GFP", las=2, cex.names = 0.5, names.arg=str_sub(sampleNames(filteredData)))
```


```{r Data extraction and plotting}
#Transfer data into a dataframe and produce summary stats

#Summary Statistics of Normalized Filtered Data
#Move filtered data into a dataframe
filtered.data <- data.frame(FSC.A=NA,SSC.A=NA,FL1.A=NA, FL2.A=NA, FL3.A=NA, FL4.A=NA, SAMPLE=NA, STRAIN=NA, GENOTYPE=NA, POPULATION=NA, VESSEL=NA, MEDIA=NA, PLOIDY=NA, WELL=NA, EXP=NA, TIMEPOINT=NA, RUN=NA)
stats.data <- data.frame(SAMPLE=NA,STRAIN=NA,POPULATION=NA,VESSEL=NA,TIMEPOINT=NA,COUNT=NA,FSC_MEDIAN=NA,FSC_MEAN=NA,FSC_SD=NA,FL1_MEDIAN=NA,FL1_MEAN=NA,FL1_SD=NA,NORMALIZED_GFP_MEDIAN=NA,NORMALIZED_GFP_MEAN=NA,NORMALIZED_GFP_SD=NA)

for(i in 1:length(filteredData)){
  fsc.a <- exprs(filteredData[[i,1]])
  ssc.a <- exprs(filteredData[[i,2]])
  fl1.a <- exprs(filteredData[[i,3]])
  fl2.a <- exprs(filteredData[[i,4]])
  fl3.a <- exprs(filteredData[[i,5]])
  fl4.a <- exprs(filteredData[[i,6]])
  sample <- sampleNames(filteredData)[i]
  well <- pData(filteredData)$Well[i]
  strain <- pData(filteredData)$Strain[i]
  genotype <- pData(filteredData)$Genotype[i]
  ploidy <- pData(filteredData)$Ploidy[i]
  media <- pData(filteredData)$Media[i]
  exp <- pData(filteredData)$Experiment[i]

  filtered.data<-rbind(filtered.data,cbind(FSC.A=fsc.a,SSC.A=ssc.a,FL1.A=fl1.a,FL2.A=fl2.a, FL3.A=fl3.a, FL4.A=fl4.a,SAMPLE=sample, STRAIN=strain, GENOTYPE=genotype, POPULATION = population, VESSEL=vessel, MEDIA=media, PLOIDY=ploidy, WELL=well, EXP=exp, TIMEPOINT=timepoint, RUN=run))
  
  stats.data<-(rbind(stats.data,cbind(SAMPLE=sample,STRAIN=strain,POPULATION=population,VESSEL=vessel,TIMEPOINT=timepoint,COUNT=length(fsc.a),FSC_MEDIAN=median(fsc.a),FSC_MEAN=mean(fsc.a),FSC_SD=sd(fsc.a),FL1_MEDIAN=median(fl1.a),FL1_MEAN=mean(fl1.a),FL1_SD=sd(fl1.a),NORMALIZED_GFP_MEDIAN=median(fl1.a/fsc.a),NORMALIZED_GFP_MEAN=mean(fl1.a/fsc.a),NORMALIZED_GFP_SD=sd(fl1.a/fsc.a))))
}  



 #Cleans up DataFrames
  filtered.data<-filtered.data[2:nrow(filtered.data),]
  filtered.data$FSC.A<-as.numeric(filtered.data$FSC.A)
  filtered.data$SSC.A<-as.numeric(filtered.data$SSC.A)
  filtered.data$FL1.A<-as.numeric(filtered.data$FL1.A)
  filtered.data$FL2.A<-as.numeric(filtered.data$FL2.A)
  filtered.data$FL3.A<-as.numeric(filtered.data$FL3.A)
  filtered.data$FL4.A<-as.numeric(filtered.data$FL4.A)
  filtered.data$SAMPLE<-as.factor(filtered.data$SAMPLE)
  filtered.data$WELL<-as.factor(filtered.data$WELL)
  filtered.data$STRAIN<-as.factor(filtered.data$STRAIN)
  filtered.data$GENOTYPE<-as.factor(filtered.data$GENOTYPE)
  filtered.data$PLOIDY<-as.factor(filtered.data$PLOIDY)
  filtered.data$MEDIA<-as.factor(filtered.data$MEDIA)
  filtered.data$EXP<-as.factor(filtered.data$EXP)
  
  
  stats.data<-stats.data[2:nrow(stats.data),]
  stats.data$SAMPLE<-as.factor(stats.data$SAMPLE)
  stats.data$STRAIN<-as.factor(stats.data$STRAIN)
  stats.data$POPULATION<-as.factor(stats.data$POPULATION)
  stats.data$VESSEL<-as.factor(stats.data$VESSEL)
  stats.data$TIMEPOINT<-as.factor(stats.data$TIMEPOINT)
  stats.data$COUNT<-as.numeric(stats.data$COUNT)
  stats.data$FSC_MEDIAN<-as.numeric(stats.data$FSC_MEDIAN)
  stats.data$FSC_MEAN<-as.numeric(stats.data$FSC_MEAN)    
  stats.data$FSC_SD<-as.numeric(stats.data$FSC_SD)
  stats.data$FL1_MEDIAN<-as.numeric(stats.data$FL1_MEDIAN)
  stats.data$FL1_MEAN<-as.numeric(stats.data$FL1_MEAN)    
  stats.data$FL1_SD<-as.numeric(stats.data$FL1_SD)
  stats.data$NORMALIZED_GFP_MEDIAN<-as.numeric(stats.data$NORMALIZED_GFP_MEDIAN)
  stats.data$NORMALIZED_GFP_MEAN<-as.numeric(stats.data$NORMALIZED_GFP_MEAN)    
  stats.data$NORMALIZED_GFP_SD<-as.numeric(stats.data$NORMALIZED_GFP_SD)
  
```