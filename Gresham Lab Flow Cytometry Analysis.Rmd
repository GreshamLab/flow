---
title: "Gresham Lab Flow Core Guide"
author: '`r Sys.info()[7]`'
date: '`r Sys.Date()`'
output:
  html_document:
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    toc: yes
---

#1) Write a detailed description of your experiment here.  If you still see this text it means that you have not described the experiment and whatever follows is meaningless.

#2) Be sure to include a relevant title

#3) Delete text containing points 1-3 

###This code is designed for use with the Accuri flow cytometer, which is equiped with the following lasers and filters

* Blue laser (488 nm)
  + FL1 filter = 514/20nm   GFP
  + FL3 filter = 575/25nm   YFP

* Yellow/green laser (552 nm)
  + FL2 filter = 610/20nm   mCherry, dtomato
  + FL4 filter = 586/15nm   DsRed

###It is also designed for use with the CGSB Aria, which has the following lasers and printers

###In order to run this code you need to predefine your gates using the gating.R script

###This script generates a summary of results followed by quality control plots


##Step 1: Load relevant libraries 
```{r, eval=TRUE}
# This is a function that just makes sure you have a package, or installs it for you without prompting

requireInstall <- function(packageName,isBioconductor=F) {
  if ( !try(require(packageName,character.only=T)) ) {
    print(paste0("You don't have ",packageName," accessible, ",
      "I'm gonna install it"))
    if (isBioconductor) {
      source("http://bioconductor.org/biocLite.R")                        
      biocLite(packageName)                                                 
    } else {
      install.packages("packageName")
    }
  }
  return(1)
}

#Load libraries
requireInstall("flowCore",isBioconductor=T)
requireInstall("flowViz",isBioconductor=T)
#requireInstall("flowStats")
#requireInstall("Hmisc")
requireInstall("reshape2")
requireInstall("ggplot2")
#requireInstall("flowWorkspace")
#requireInstall("ggcyto", isBioconductor=T)
#requireInstall("gridExtra")


```

###Step 2: Read in .fcs files, an Rdata file containing the gates sample sheet(s) that contains four columns with 
* column1 = Well
* column2 = Strain
* column3 = Staining
* column4 = Media
* column5 = Userdefined

```{r}
#Read in all data for analysis. Data should be in individual directories that contain .fcs files and a corresponding sample sheet with a generic format. FCS file names should be unaltered e.g AO1.fcs, A02.fcs, ...H12.fcs 
#An abitrary number of directories can be used named dir1, dir2, dir3...with a corresponding flowData.1, flowData.2, flowData.3...and sample.sheet.1, sample.sheet.2, sample.sheet.3...

#load the Rdata file containing the gates
load("gates.Rdata") 

#Define how many directories that will be analyzed
num <- 1

#Define the directory, or directories, containing your .fcs files using absolute path names 
dir1 <- "/Users/David/Google Drive/Gresham Lab_David/flow/flow cytometry"
#dir2 <- "/Users/David/Google Drive/Gresham Lab_David/GreshamLab Flow Cytometry 2016/2015_12_02"

#Read in all the fcs files in the directory, with alter.names changing "-" to "."  
flowData.1 <- read.flowSet(path = dir1, pattern=".fcs", alter.names=TRUE)
#flowData.2 <- read.flowSet(path = dir2, pattern=".fcs", alter.names=TRUE)

#Read in the sample sheet that should be in each directory that contains the .fcs files.  
sample.sheet.1 <- read.csv(paste(dir1, "SampleSheet.csv", sep="/"))
#sample.sheet.2 <- read.csv(paste(dir2, "SampleSheet.csv", sep="/"))

```


```{r}
#Check how many cells were counted in each fcs file
fsApply(flowData.1, each_col, length)[1:6]
total <- fsApply(flowData.1, each_col, length)[1:6]
#fsApply(flowData.2, each_col, length)

#Print the medians of data values for each measurement
fsApply(flowData.1, each_col, median)
#fsApply(flowData.2, each_col, median)
```


###Step 3: apply filters to data and generate plots showing the effect on filtering
```{r}
##Subset the data by applying sequential gates##

#this filters doublets
flowData.1.1 <- Subset(flowData.1, pg.singlets) 
fsApply(flowData.1.1, each_col, length)[1:6]
singlets <- fsApply(flowData.1.1, each_col, length)[1:6]
barplot(singlets/total, ylim=c(0,1), ylab = "Proportion singlet cells", names.arg=sample.sheet.1[,1])

#this removes debris from the singlet cells
filterData.1.1.1 <- Subset(flowData.1.1, pg.nondebris) 
fsApply(filterData.1.1.1, each_col, length)[1:6]
non.debris <- fsApply(filterData.1.1.1, each_col, length)[1:6]
barplot(non.debris/total, ylim=c(0,1), ylab = "Proportion singlet and nondebris cells", names.arg=sample.sheet.1[,1])

#non.debris is the filtered data that will be used for all subsequent analyses

#this identifies nongfp cells
gfp.neg <- Subset(filterData.1.1.1, pg.nongfp) 
fsApply(gfp.neg, each_col, length)[1:6]
non.gfp <- fsApply(gfp.neg, each_col, length)[1:6]
barplot(non.gfp/non.debris, ylim=c(0,1), ylab = "Proportion cells with no GFP", names.arg=sample.sheet.1[,1])

#this identifies gfp cells
gfp.pos <- Subset(filterData.1.1.1, pg.gfp) 
fsApply(gfp.pos, each_col, length)[1:6]
gfp.cells <- fsApply(gfp.pos, each_col, length)[1:6]
barplot(gfp.cells/non.debris, ylim=c(0,1), ylab = "Proportion cells with GFP", names.arg=sample.sheet.1[,1])

#this identifies high GFP cells
gfp.hi <- Subset(filterData.1.1.1, pg.hi.gfp) 
fsApply(gfp.hi, each_col, length)[1:6]
hi.gfp.cells <- fsApply(gfp.hi, each_col, length)[1:6]
barplot(hi.gfp.cells/non.debris, ylim=c(0,1), ylab = "Proportion cells with high GFP", names.arg=sample.sheet.1[,1])
```


