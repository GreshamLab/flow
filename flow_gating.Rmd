---
title: "R Notebook"
"Flow Cytometry Gating"
author: 'G. Avecilla, N. Brandt, S. Lauer, F. Abdul-Rahman, D. Gresham'
date: '`r Sys.Date()`'
output: html_document
runtime: shiny
---

This script is intended to read in .fcs files and perform manual gating for

1. single cells 
2. debris
3. (optionally) fluorescence

This script requires a .csv samplesheet and user defined variables.
The user must define which controls are present, and the strain name for these controls.
**Currently this script only gates fluorescence using the FL1 (GFP) filter**  
If controls are not present, the script will only gate for singlets and debris. 
Sometimes gating must be done individually for groups of samples in different conditions (i.e., grown in different media). If so, the user must set the gate_by variable to the column name by which to group the data. There must be a set of controls for each condition.

Gating is performed with untransformed data.

Individual gates are saved in a .Rdata file for use with the Gresham Lab Flow Cytometry Analysis.Rmd pipeline.


```{r}
requireInstall <- function(packageName,isBioconductor=F) {
  if ( !try(require(packageName,character.only=T)) ) {
    print(paste0("You don't have ",packageName," accessible, ",
      "I'm gonna install it"))
    if (isBioconductor) {
      source("http://bioconductor.org/biocLite.R")                        
      biocLite(packageName)                                                 
    } else {
      install.packages("packageName", repos = "http://cran.us.r-project.org")
    }
  }
  return(1)
}
#Load libraries
requireInstall('tidyverse')
requireInstall("openCyto",isBioconductor=T)
```


**Variables and Output Settings**

```{r Set user defined variables}
#working directory
dir = '.'

#file location of fcs and sampleshhet
path.data = paste(getwd(),"/",sep="")

#fcs run sample name
name = "Test"

#get/set samplesheet parameters ###DO I NEED THESE???###
sample.param <- as_tibble(matrix(nrow=0, ncol = ncol(sample.sheet)))
colnames(sample.param) <- colnames(sample.sheet)

#set control names (strain name in samplesheet)
zero_ctrl = NA
one_ctrl = NA
two_ctrl = NA

#set condition to gate by
gate_by = NA

#set output .Rdata name
out_rdata = paste(name, 'gates', Sys.Date(), sep = '_')
```

**Read in Data**
*.fcs files must be in a folder with a unique name and have an accompanying .csv samplesheet
The samplesheet name format must be samplesheet_"unique name".csv
It must contain the following columns, in addition you may add additioanl columns depending on your needs

#This needs to be determined
Need to define names
* column1 = Well
* column2 = Strain
* column3 = Staining
* column4 = Media
* column5 = Userdefined

```{r}
files<-list.files(paste(path.data,name,"/", sep=""),full.names=TRUE)
flowData <- read.ncdfFlowSet(files=files, pattern=".fcs", alter.names = TRUE)


sample.sheet <- read.csv(paste(path.data,"samplesheet_",name,".csv", sep=""))

#Adds a sample sheet data to the pData of the flowset
sampleNames(flowData) <- paste(gsub(" ","_",sample.sheet$Strain),"_",sub(" ","_",sample.sheet$Well), sep="")

#Need to determine samplesheet inputs
pData(flowData)$Well <- sample.sheet$Well
pData(flowData)$Strain <- sample.sheet$Strain
pData(flowData)$Genotype <- sample.sheet$Genotype
pData(flowData)$Ploidy <- sample.sheet$Ploidy
pData(flowData)$Media <- sample.sheet$Media
pData(flowData)$Experiment <- sample.sheet$Experiment
```

**Create singlet gates**

```{r}

```

